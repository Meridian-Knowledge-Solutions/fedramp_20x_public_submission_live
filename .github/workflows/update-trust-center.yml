name: üèõÔ∏è Update Trust Center - RFC-0016 Integration

on:
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if already integrated'
        required: false
        default: 'false'
        type: boolean
  push:
    paths:
      - 'update_trust_center.py'
      - '.github/workflows/update-trust-center.yml'

jobs:
  update-trust-center:
    runs-on: ubuntu-latest
    
    steps:
      - name: üîÑ Checkout Repository
        uses: actions/checkout@v4
          
      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: üîç Check if Trust Center Update Needed
        id: check-update
        run: |
          if [ "${{ github.event.inputs.force_update }}" = "true" ]; then
            echo "need_update=true" >> $GITHUB_OUTPUT
            echo "üîß Force update requested"
          elif grep -q "quarterly-reports-section" index.html; then
            echo "need_update=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Trust Center already integrated - skipping"
          else
            echo "need_update=true" >> $GITHUB_OUTPUT
            echo "üÜï Trust Center integration needed"
          fi
          
      - name: üèõÔ∏è Update Trust Center for RFC-0016
        if: steps.check-update.outputs.need_update == 'true'
        run: |
          echo "üöÄ Running Trust Center RFC-0016 integration..."
          python trust_center_updater.py
          
      - name: üìã Verify Integration
        if: steps.check-update.outputs.need_update == 'true'
        run: |
          if grep -q "quarterly-reports-section" index.html; then
            echo "‚úÖ Trust Center successfully integrated"
            echo "üîç Checking for required components..."
            
            # Check for key components
            if grep -q "Quarterly Authorization Reports" index.html; then
              echo "  ‚úÖ Quarterly Reports card found"
            fi
            
            if grep -q "RFC-0016" index.html; then
              echo "  ‚úÖ RFC-0016 compliance labels found"
            fi
            
            if grep -q "loadQuarterlyReportData" index.html; then
              echo "  ‚úÖ JavaScript functions integrated"
            fi
            
            if grep -q "quarterly-schedule" index.html; then
              echo "  ‚úÖ CSS styles integrated"
            fi
            
            echo "üéâ Trust Center integration complete!"
          else
            echo "‚ùå Trust Center integration failed"
            exit 1
          fi
          
      - name: üìã Verify Existing Data
        if: steps.check-update.outputs.need_update == 'true'
        run: |
          if [ -d "quarterly_reports" ]; then
            echo "‚úÖ quarterly_reports/ directory exists"
          else
            echo "‚ö†Ô∏è quarterly_reports/ not found - will be created by sync from private repo"
          fi
          
          if [ -d "trust_center" ]; then
            echo "‚úÖ trust_center/ directory exists"
          else
            echo "‚ö†Ô∏è trust_center/ not found - will be created by sync from private repo"
          fi
          
      - name: üìä Generate Summary
        if: steps.check-update.outputs.need_update == 'true'
        run: |
          echo "üìä Trust Center HTML Update Summary:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **RFC-0016 HTML Interface Updated**" >> $GITHUB_STEP_SUMMARY
          echo "- Quarterly Authorization Reports card added to Trust Center" >> $GITHUB_STEP_SUMMARY
          echo "- Federal agency meeting registration interface" >> $GITHUB_STEP_SUMMARY
          echo "- Quarterly report download functionality" >> $GITHUB_STEP_SUMMARY
          echo "- Agency feedback mechanism (FRR-CCM-04)" >> $GITHUB_STEP_SUMMARY
          echo "- CSS and JavaScript for interactive features" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìÅ **Data Dependencies:**" >> $GITHUB_STEP_SUMMARY
          echo "- quarterly_reports/ (synced from private repo)" >> $GITHUB_STEP_SUMMARY
          echo "- trust_center/next_report_date.json (generated by quarterly report script)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üîó **Workflow Integration:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Private repo generates quarterly reports" >> $GITHUB_STEP_SUMMARY
          echo "2. Private repo syncs data to public repo" >> $GITHUB_STEP_SUMMARY
          echo "3. This workflow updates Trust Center HTML interface" >> $GITHUB_STEP_SUMMARY
          echo "4. Federal agencies access via public Trust Center" >> $GITHUB_STEP_SUMMARY
          
      - name: üîÑ Commit HTML Changes
        if: steps.check-update.outputs.need_update == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if [ -n "$(git status --porcelain index.html)" ]; then
            git add index.html
            git commit -m "üèõÔ∏è Update Trust Center HTML for RFC-0016 Compliance

            - Replace Incident Reports with Quarterly Authorization Reports
            - Add RFC-0016 FRR-CCM compliant interface
            - Enable federal agency self-service access
            - Add quarterly report download and meeting registration
            
            Compliance: RFC-0016 FRR-CCM-03, FRR-CCM-QR-05"
            
            git push
            echo "‚úÖ Trust Center HTML updated and pushed"
          else
            echo "‚ÑπÔ∏è No HTML changes to commit"
          fi
