name: ğŸ›ï¸ Update Trust Center - RFC-0016 Integration

on:
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if already integrated'
        required: false
        default: 'false'
        type: boolean
  push:
    paths:
      - 'update_trust_center.py'
      - '.github/workflows/update-trust-center.yml'

permissions:
  contents: write
  actions: read

jobs:
  update-trust-center:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: ğŸ”§ Configure Git
        run: |
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: ğŸ” Check if Trust Center Update Needed
        id: check-update
        run: |
          if [ "${{ github.event.inputs.force_update }}" = "true" ]; then
            echo "need_update=true" >> $GITHUB_OUTPUT
            echo "ğŸ”§ Force update requested"
          elif grep -q "quarterly-reports-section" index.html; then
            echo "need_update=false" >> $GITHUB_OUTPUT
            echo "âœ… Trust Center already integrated - skipping"
          else
            echo "need_update=true" >> $GITHUB_OUTPUT
            echo "ğŸ†• Trust Center integration needed"
          fi
          
      - name: ğŸ›ï¸ Update Trust Center for RFC-0016
        if: steps.check-update.outputs.need_update == 'true'
        run: |
          echo "ğŸš€ Running Trust Center RFC-0016 integration..."
          python trust_center_updater.py
          
      - name: ğŸ“‹ Verify Integration
        if: steps.check-update.outputs.need_update == 'true'
        run: |
          if grep -q "quarterly-reports-section" index.html; then
            echo "âœ… Trust Center successfully integrated"
            echo "ğŸ” Checking for required components..."
            
            # Check for key components
            if grep -q "Quarterly Authorization Reports" index.html; then
              echo "  âœ… Quarterly Reports card found"
            fi
            
            if grep -q "RFC-0016" index.html; then
              echo "  âœ… RFC-0016 compliance labels found"
            fi
            
            if grep -q "loadQuarterlyReportData" index.html; then
              echo "  âœ… JavaScript functions integrated"
            fi
            
            if grep -q "quarterly-schedule" index.html; then
              echo "  âœ… CSS styles integrated"
            fi
            
            echo "ğŸ‰ Trust Center integration complete!"
          else
            echo "âŒ Trust Center integration failed"
            exit 1
          fi
          
      - name: ğŸ“‹ Verify Existing Data
        if: steps.check-update.outputs.need_update == 'true'
        run: |
          if [ -d "quarterly_reports" ]; then
            echo "âœ… quarterly_reports/ directory exists"
          else
            echo "âš ï¸ quarterly_reports/ not found - will be created by sync from private repo"
          fi
          
          if [ -d "trust_center" ]; then
            echo "âœ… trust_center/ directory exists"
          else
            echo "âš ï¸ trust_center/ not found - will be created by sync from private repo"
          fi
          
      - name: ğŸ“Š Generate Summary
        if: steps.check-update.outputs.need_update == 'true'
        run: |
          echo "ğŸ“Š Trust Center HTML Update Summary:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **RFC-0016 HTML Interface Updated**" >> $GITHUB_STEP_SUMMARY
          echo "- Quarterly Authorization Reports card added to Trust Center" >> $GITHUB_STEP_SUMMARY
          echo "- Federal agency meeting registration interface" >> $GITHUB_STEP_SUMMARY
          echo "- Quarterly report download functionality" >> $GITHUB_STEP_SUMMARY
          echo "- Agency feedback mechanism (FRR-CCM-04)" >> $GITHUB_STEP_SUMMARY
          echo "- CSS and JavaScript for interactive features" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“ **Data Dependencies:**" >> $GITHUB_STEP_SUMMARY
          echo "- quarterly_reports/ (synced from private repo)" >> $GITHUB_STEP_SUMMARY
          echo "- trust_center/next_report_date.json (generated by quarterly report script)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”— **Workflow Integration:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Private repo generates quarterly reports" >> $GITHUB_STEP_SUMMARY
          echo "2. Private repo syncs data to public repo" >> $GITHUB_STEP_SUMMARY
          echo "3. This workflow updates Trust Center HTML interface" >> $GITHUB_STEP_SUMMARY
          echo "4. Federal agencies access via public Trust Center" >> $GITHUB_STEP_SUMMARY
          
      - name: ğŸ”„ Commit HTML Changes
        if: steps.check-update.outputs.need_update == 'true'
        run: |
          if [ -n "$(git status --porcelain index.html)" ]; then
            git add index.html
            git commit -m "ğŸ›ï¸ Update Trust Center HTML for RFC-0016 Compliance

            - Replace Incident Reports with Quarterly Authorization Reports
            - Add RFC-0016 FRR-CCM compliant interface
            - Enable federal agency self-service access
            - Add quarterly report download and meeting registration
            
            Compliance: RFC-0016 FRR-CCM-03, FRR-CCM-QR-05"
            
            git push
            echo "âœ… Trust Center HTML updated and pushed"
          else
            echo "â„¹ï¸ No HTML changes to commit"
          fi
