name: ğŸ”§ Fix Dashboard JavaScript

on:
  workflow_dispatch:
    inputs:
      fix_type:
        description: 'Fix type'
        required: true
        default: 'diagnostic'
        type: choice
        options:
          - diagnostic
          - quick_fix
          - both

permissions:
  contents: write
  actions: read

jobs:
  fix-dashboard:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: ğŸ”§ Configure Git
        run: |
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: ğŸ“‹ Pre-Fix Diagnosis
        run: |
          echo "ğŸ” Checking current dashboard state..."
          
          if grep -q "toggleTheme" index.html; then
            echo "âœ… toggleTheme function found"
          else
            echo "âŒ toggleTheme function MISSING"
          fi
          
          if grep -q "showTab" index.html; then
            echo "âœ… showTab function found"
          else
            echo "âŒ showTab function MISSING"
          fi
          
          SCRIPT_COUNT=$(grep -c "<script" index.html)
          echo "ğŸ“Š Script tags found: $SCRIPT_COUNT"
          
          if grep -q "\\\\n\\\\n" index.html; then
            echo "âŒ Malformed newline escapes detected"
          fi
          
      - name: ğŸ”§ Run Diagnostic Fix
        if: ${{ github.event.inputs.fix_type == 'diagnostic' || github.event.inputs.fix_type == 'both' }}
        run: |
          echo "ğŸ”§ Running comprehensive diagnostic fix..."
          python fix_dashboard_js.py
          
      - name: ğŸš‘ Run Quick Minimal Fix  
        if: ${{ github.event.inputs.fix_type == 'quick_fix' || github.event.inputs.fix_type == 'both' }}
        run: |
          echo "ğŸš‘ Running quick minimal fix..."
          python -c "
          from fix_dashboard import quick_minimal_fix
          quick_minimal_fix()
          "
          
      - name: ğŸ“‹ Post-Fix Validation
        run: |
          echo "ğŸ§ª Validating fixes..."
          
          if grep -q "function toggleTheme" index.html; then
            echo "âœ… toggleTheme function restored"
          else
            echo "âŒ toggleTheme still missing"
          fi
          
          if grep -q "function showTab" index.html; then
            echo "âœ… showTab function restored"  
          else
            echo "âŒ showTab still missing"
          fi
          
          if grep -q "DOMContentLoaded" index.html; then
            echo "âœ… DOMContentLoaded initialization found"
          else
            echo "âŒ DOMContentLoaded initialization missing"
          fi
          
          SCRIPT_COUNT_AFTER=$(grep -c "<script" index.html)
          echo "ğŸ“Š Script tags after fix: $SCRIPT_COUNT_AFTER"
          
          # Check for syntax issues
          if grep -q "\\\\n\\\\nOpen" index.html; then
            echo "âŒ Still has quote escaping issues"
          else
            echo "âœ… Quote escaping looks clean"
          fi
          
      - name: ğŸ”„ Commit JavaScript Fixes
        run: |
          if [ -n "$(git status --porcelain index.html)" ]; then
            git add index.html
            git commit -m "ğŸ”§ Fix Dashboard JavaScript Issues

            - Restore missing toggleTheme and showTab functions
            - Fix malformed JavaScript strings and escaping
            - Add proper DOMContentLoaded initialization
            - Clean up duplicate script sections
            
            Fix Type: ${{ github.event.inputs.fix_type }}"
            
            git push
            echo "âœ… JavaScript fixes committed and pushed"
          else
            echo "â„¹ï¸ No JavaScript changes needed"
          fi
          
      - name: ğŸ“Š Generate Fix Summary
        run: |
          echo "ğŸ”§ Dashboard JavaScript Fix Summary:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Fix Type:** ${{ github.event.inputs.fix_type }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check what functions exist now
          if grep -q "function toggleTheme" index.html; then
            echo "âœ… **toggleTheme**: Function restored" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **toggleTheme**: Still missing" >> $GITHUB_STEP_SUMMARY
          fi
          
          if grep -q "function showTab" index.html; then
            echo "âœ… **showTab**: Function restored" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **showTab**: Still missing" >> $GITHUB_STEP_SUMMARY
          fi
          
          if grep -q "loadQuarterlyReportData" index.html; then
            echo "âœ… **loadQuarterlyReportData**: Quarterly reports integration intact" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **loadQuarterlyReportData**: May need quarterly reports re-integration" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ§ª **Testing Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Refresh browser and test dashboard" >> $GITHUB_STEP_SUMMARY
          echo "2. Try switching between tabs (KSI Dashboard, Trust Center)" >> $GITHUB_STEP_SUMMARY
          echo "3. Test theme toggle button" >> $GITHUB_STEP_SUMMARY
          echo "4. Check browser console for remaining errors" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "If issues persist, try running with 'both' fix type or restore from backup." >> $GITHUB_STEP_SUMMARY
