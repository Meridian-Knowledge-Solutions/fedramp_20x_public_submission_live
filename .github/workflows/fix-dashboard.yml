name: 🔧 Fix Dashboard JavaScript

on:
  workflow_dispatch:
    inputs:
      fix_type:
        description: 'Fix type'
        required: true
        default: 'diagnostic'
        type: choice
        options:
          - diagnostic
          - quick_fix
          - both

permissions:
  contents: write
  actions: read

jobs:
  fix-dashboard:
    runs-on: ubuntu-latest
    
    steps:
      - name: 🔄 Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: 🔧 Configure Git
        run: |
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
      - name: 🐍 Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: 📋 Pre-Fix Diagnosis
        run: |
          echo "🔍 Checking current dashboard state..."
          
          if grep -q "toggleTheme" index.html; then
            echo "✅ toggleTheme function found"
          else
            echo "❌ toggleTheme function MISSING"
          fi
          
          if grep -q "showTab" index.html; then
            echo "✅ showTab function found"
          else
            echo "❌ showTab function MISSING"
          fi
          
          SCRIPT_COUNT=$(grep -c "<script" index.html)
          echo "📊 Script tags found: $SCRIPT_COUNT"
          
          if grep -q "\\\\n\\\\n" index.html; then
            echo "❌ Malformed newline escapes detected"
          fi
          
      - name: 🔧 Run Diagnostic Fix
        if: ${{ github.event.inputs.fix_type == 'diagnostic' || github.event.inputs.fix_type == 'both' }}
        run: |
          echo "🔧 Running comprehensive diagnostic fix..."
          python fix_dashboard_js.py
          
      - name: 🚑 Run Quick Minimal Fix  
        if: ${{ github.event.inputs.fix_type == 'quick_fix' || github.event.inputs.fix_type == 'both' }}
        run: |
          echo "🚑 Running quick minimal fix..."
          python -c "
          from fix_dashboard import quick_minimal_fix
          quick_minimal_fix()
          "
          
      - name: 📋 Post-Fix Validation
        run: |
          echo "🧪 Validating fixes..."
          
          if grep -q "function toggleTheme" index.html; then
            echo "✅ toggleTheme function restored"
          else
            echo "❌ toggleTheme still missing"
          fi
          
          if grep -q "function showTab" index.html; then
            echo "✅ showTab function restored"  
          else
            echo "❌ showTab still missing"
          fi
          
          if grep -q "DOMContentLoaded" index.html; then
            echo "✅ DOMContentLoaded initialization found"
          else
            echo "❌ DOMContentLoaded initialization missing"
          fi
          
          SCRIPT_COUNT_AFTER=$(grep -c "<script" index.html)
          echo "📊 Script tags after fix: $SCRIPT_COUNT_AFTER"
          
          # Check for syntax issues
          if grep -q "\\\\n\\\\nOpen" index.html; then
            echo "❌ Still has quote escaping issues"
          else
            echo "✅ Quote escaping looks clean"
          fi
          
      - name: 🔄 Commit JavaScript Fixes
        run: |
          if [ -n "$(git status --porcelain index.html)" ]; then
            git add index.html
            git commit -m "🔧 Fix Dashboard JavaScript Issues

            - Restore missing toggleTheme and showTab functions
            - Fix malformed JavaScript strings and escaping
            - Add proper DOMContentLoaded initialization
            - Clean up duplicate script sections
            
            Fix Type: ${{ github.event.inputs.fix_type }}"
            
            git push
            echo "✅ JavaScript fixes committed and pushed"
          else
            echo "ℹ️ No JavaScript changes needed"
          fi
          
      - name: 📊 Generate Fix Summary
        run: |
          echo "🔧 Dashboard JavaScript Fix Summary:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Fix Type:** ${{ github.event.inputs.fix_type }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check what functions exist now
          if grep -q "function toggleTheme" index.html; then
            echo "✅ **toggleTheme**: Function restored" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **toggleTheme**: Still missing" >> $GITHUB_STEP_SUMMARY
          fi
          
          if grep -q "function showTab" index.html; then
            echo "✅ **showTab**: Function restored" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **showTab**: Still missing" >> $GITHUB_STEP_SUMMARY
          fi
          
          if grep -q "loadQuarterlyReportData" index.html; then
            echo "✅ **loadQuarterlyReportData**: Quarterly reports integration intact" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ **loadQuarterlyReportData**: May need quarterly reports re-integration" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "🧪 **Testing Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Refresh browser and test dashboard" >> $GITHUB_STEP_SUMMARY
          echo "2. Try switching between tabs (KSI Dashboard, Trust Center)" >> $GITHUB_STEP_SUMMARY
          echo "3. Test theme toggle button" >> $GITHUB_STEP_SUMMARY
          echo "4. Check browser console for remaining errors" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "If issues persist, try running with 'both' fix type or restore from backup." >> $GITHUB_STEP_SUMMARY
